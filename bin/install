#!/bin/bash -e

PATH=/bin/:/usr/bin:$PATH

source $OPENSHIFT_CARTRIDGE_SDK_BASH

case "$1" in
  -v|--version)
    version="$2"
esac

client_result "Install called $version"

DOWNLOAD_FILE_JBOSS="${version}-jboss.zip"
DOWNLOAD_FILE_TOMCAT="${version}-tomcat.zip"

DOWNLOAD_LOCATION=$PLANON_FILESERVER_URL

cd $OPENSHIFT_PLN_DIR

#Get the right DB connections 

client_result "Request database "
wget -q --http-user=cockpit --http-password=test1234 --output-document=$OPENSHIFT_PLN_DIR/conf/planon-ds.xml $PLANON_COCKPIT_URL/Database/${OPENSHIFT_APP_DNS}/${version}
client_result "Request database executed name : ${OPENSHIFT_APP_DNS}"

client_result "JBoss download started"

wget -q $DOWNLOAD_LOCATION/$DOWNLOAD_FILE_JBOSS

client_result "JBoss downloaded ended"

unzip -q $DOWNLOAD_FILE_JBOSS -d PlanonProCenter

client_result "JBoss unzipped "

rm $DOWNLOAD_FILE_JBOSS

chmod +x PlanonProCenter/jboss-6.1.0.Final/bin/run.sh
chmod +x PlanonProCenter/jboss-6.1.0.Final/bin/shutdown.sh

cp $OPENSHIFT_PLN_DIR/conf/jboss-service.xml PlanonProCenter/jboss-6.1.0.Final/server/default/deploy/http-invoker.sar/META-INF/
cp $OPENSHIFT_PLN_DIR/conf/jndi.properties PlanonProCenter/jboss-6.1.0.Final/server/default/conf/
cp $OPENSHIFT_PLN_DIR/conf/hornetq-jms.xml PlanonProCenter/jboss-6.1.0.Final/server/default/deploy/hornetq/
#cp $OPENSHIFT_PLN_DIR/conf/planon-ds.xml PlanonProCenter/jboss-6.1.0.Final/server/default/deploy

#TOMCAT

client_result "Tomcat download started"

wget -q $DOWNLOAD_LOCATION/$DOWNLOAD_FILE_TOMCAT

client_result "Tomcat downloaded ended"

unzip -q $DOWNLOAD_FILE_TOMCAT -d PlanonProCenter

client_result "Tomcat unzipped"

rm $DOWNLOAD_FILE_TOMCAT

cp $OPENSHIFT_PLN_DIR/conf/setenv.sh PlanonProCenter/tomcat-7.0.47/bin/
cp $OPENSHIFT_PLN_DIR/conf/jndi.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/mobile.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/planon.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/sdk.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/logging.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/mobile.logging.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/planon.logging.properties PlanonProCenter/tomcat-7.0.47/conf/
cp $OPENSHIFT_PLN_DIR/conf/sdk.logging.properties PlanonProCenter/tomcat-7.0.47/conf/


chmod +x PlanonProCenter/tomcat-7.0.47/bin/startup.sh
chmod +x PlanonProCenter/tomcat-7.0.47/bin/catalina.sh
chmod +x PlanonProCenter/tomcat-7.0.47/bin/shutdown.sh
chmod +x PlanonProCenter/tomcat-7.0.47/bin/setenv.sh

client_result "Waiting for database to be ready."

#wait till the database is ready stop after 80 seconds
COUNTER=0
while [ ! -s "$OPENSHIFT_PLN_DIR/conf/planon-ds.xml" ]
do
  let COUNTER=COUNTER+1 
  sleep 10  
  client_result "Check if database is ready.($COUNTER)"
  wget -q --http-user=cockpit --http-password=test1234 --output-document=$OPENSHIFT_PLN_DIR/conf/planon-ds.xml $PLANON_COCKPIT_URL/Database/${OPENSHIFT_APP_DNS}/${version}
  if [ COUNTER >7 ]; then
        break
  fi
done

if [ -s "$OPENSHIFT_PLN_DIR/conf/planon-ds.xml" ] then
  client_result "Database not ready, still taking a shot."
else
  client_result "Database is ready."
fi


cp $OPENSHIFT_PLN_DIR/conf/planon-ds.xml PlanonProCenter/jboss-6.1.0.Final/server/default/deploy

exit 0
